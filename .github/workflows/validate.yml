# GitHub Actions workflow for Dreamweaving validation
# Runs on push and pull requests to main branch

name: Validate

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'knowledge/**'
      - '.github/workflows/**'
      - 'requirements.txt'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'knowledge/**'
      - '.github/workflows/**'
      - 'requirements.txt'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run Doctor (quick check)
        run: |
          python3 scripts/utilities/doctor.py --quick --json > doctor_report.json
          cat doctor_report.json
        continue-on-error: true

      - name: Lint with flake8 (critical errors)
        run: |
          flake8 scripts/ --select=E9,F63,F7,F82 --show-source --statistics

      - name: Lint with flake8 (warnings)
        run: |
          flake8 scripts/ --select=E,W --ignore=E501,W503 --statistics --exit-zero

      - name: Check YAML syntax
        run: |
          python3 -c "
          import yaml
          from pathlib import Path

          errors = []
          for f in Path('knowledge').rglob('*.yaml'):
              try:
                  yaml.safe_load(f.read_text())
              except Exception as e:
                  errors.append(f'{f}: {e}')

          if errors:
              print('YAML errors found:')
              for e in errors:
                  print(f'  - {e}')
              exit(1)
          print('All YAML files valid')
          "

      - name: Validate error catalog
        run: |
          python3 -c "
          import yaml
          from pathlib import Path

          catalog_path = Path('.claude/error_catalog.yaml')
          if catalog_path.exists():
              catalog = yaml.safe_load(catalog_path.read_text())
              errors = catalog.get('errors', {})
              print(f'Error catalog: {len(errors)} errors defined')
              for eid, edef in errors.items():
                  required = ['symptoms', 'keywords', 'severity', 'agent']
                  missing = [r for r in required if r not in edef]
                  if missing:
                      print(f'  WARNING: {eid} missing: {missing}')
          else:
              print('Error catalog not found')
          "

      - name: Run tests (if exist)
        run: |
          if [ -d "tests" ] && [ -n "$(ls -A tests/*.py 2>/dev/null)" ]; then
            python -m pytest tests/ -v -m "not slow and not integration" --tb=short
          else
            echo "No tests found, skipping"
          fi
        continue-on-error: true

      - name: Upload doctor report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: doctor-report
          path: doctor_report.json
          retention-days: 7

  # Separate job for SSML validation (only if SSML files changed)
  validate-ssml:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: |
      contains(github.event.head_commit.modified, '.ssml') ||
      contains(github.event.head_commit.added, '.ssml')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate changed SSML files
        run: |
          # Find all SSML files
          find sessions -name "*.ssml" -type f | while read ssml; do
            echo "Validating: $ssml"
            python3 scripts/utilities/validate_ssml.py "$ssml" || echo "WARNING: $ssml has issues"
          done
